# 행사 데이터 처리 구조도

## 1. 온라인 행사 데이터 처리

### 1-1. 판매가 할인 (PRICE_DISCOUNT)

```
┌─────────────────────────────────────────────────────────────┐
│ 입력 데이터 (Promotion + PromotionProduct)                  │
├─────────────────────────────────────────────────────────────┤
│ [Promotion]                                                 │
│  - PromotionName: "쿠팡 로켓배송 특가"                       │
│  - PromotionType: PRICE_DISCOUNT                            │
│  - ChannelType: ONLINE                                      │
│  - ChannelNames: "쿠팡"                                      │
│  - SettlementType: CONSIGNMENT (위탁)                       │
│  - CommissionRate: 15%                                      │
│  - DiscountOwner: BOTH                                      │
│  - OrioShare: 60%, ChannelShare: 40%                        │
│                                                             │
│ [PromotionProduct]                                          │
│  - RegularPrice: 12,000원 (정가)                            │
│  - SellingPrice: 10,000원 (상시판매가)                      │
│  - PromotionPrice: 8,500원 (행사가)                         │
│  - SupplyPrice: 7,000원 (공급가)                            │
│  - UnitCost: 5,000원 (원가)                                 │
│  - DiscountRate: 15% (판매가 할인)                          │
│  - LogisticsCost: 500원                                     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 처리 로직 (View: vw_PromotionOnline)                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 1️⃣ 할인 금액 계산                                           │
│    SellingPrice - PromotionPrice                            │
│    = 10,000 - 8,500 = 1,500원                              │
│                                                             │
│ 2️⃣ 할인 분담액 계산                                          │
│    오리오 부담: 1,500 × 60% = 900원                         │
│    채널 부담: 1,500 × 40% = 600원                           │
│                                                             │
│ 3️⃣ 수수료 계산 (위탁)                                        │
│    PromotionPrice × CommissionRate                          │
│    = 8,500 × 15% = 1,275원                                 │
│                                                             │
│ 4️⃣ 마진 계산 (위탁)                                          │
│    PromotionPrice - UnitCost - 수수료 - LogisticsCost       │
│    = 8,500 - 5,000 - 1,275 - 500                           │
│    = 1,725원                                                │
│                                                             │
│ 5️⃣ 마진율 계산                                               │
│    (마진 / PromotionPrice) × 100                            │
│    = (1,725 / 8,500) × 100 = 20.29%                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 출력 (vw_PromotionOnline)                                   │
├─────────────────────────────────────────────────────────────┤
│  - CalculatedMarginAmount: 1,725원                          │
│  - CalculatedMarginRate: 20.29%                             │
│  - SettlementType: CONSIGNMENT                              │
│  - 오리오 할인 부담: 900원                                   │
│  - 채널 할인 부담: 600원                                     │
└─────────────────────────────────────────────────────────────┘
```

---

### 1-2. 쿠폰 할인 (COUPON)

```
┌─────────────────────────────────────────────────────────────┐
│ 입력 데이터                                                  │
├─────────────────────────────────────────────────────────────┤
│ [Promotion]                                                 │
│  - PromotionType: COUPON                                    │
│  - ChannelType: ONLINE                                      │
│  - SettlementType: CONSIGNMENT                              │
│  - CommissionRate: 15%                                      │
│                                                             │
│ [PromotionProduct]                                          │
│  - SellingPrice: 10,000원                                   │
│  - PromotionPrice: 9,500원 (판매가 할인 후)                 │
│  - CouponDiscountRate: 5% (추가 쿠폰)                       │
│  - UnitCost: 5,000원                                        │
│  - LogisticsCost: 500원                                     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 처리 로직                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 1️⃣ 최종 판매가 계산                                          │
│    PromotionPrice × (1 - CouponDiscountRate/100)            │
│    = 9,500 × (1 - 0.05) = 9,025원                          │
│                                                             │
│ 2️⃣ 수수료 계산                                               │
│    9,025 × 15% = 1,354원                                   │
│                                                             │
│ 3️⃣ 마진 계산                                                 │
│    9,025 - 5,000 - 1,354 - 500 = 2,171원                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 오프라인 행사 데이터 처리

### 2-1. 원매가 할인 (WHOLESALE_DISCOUNT)

```
┌─────────────────────────────────────────────────────────────┐
│ 입력 데이터                                                  │
├─────────────────────────────────────────────────────────────┤
│ [Promotion]                                                 │
│  - PromotionName: "롯데마트 원매가 할인"                     │
│  - PromotionType: WHOLESALE_DISCOUNT                        │
│  - ChannelType: OFFLINE                                     │
│  - ChannelNames: "롯데마트"                                  │
│  - DiscountOwner: ORIO (오리오 100% 부담)                   │
│                                                             │
│ [PromotionProduct]                                          │
│  - RegularPrice: 12,000원                                   │
│  - SellingPrice: 10,000원 (일반 공급가)                     │
│  - PromotionPrice: 10,000원 (최종 소비자가, 변동 없음)      │
│  - SupplyPrice: 6,000원 ⬅️ 원매가 할인 적용됨!              │
│  - UnitCost: 5,000원                                        │
│  - SettlementType: DIRECT (완사입)                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 처리 로직 (View: vw_PromotionOffline)                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 1️⃣ 원매가 할인액 계산                                        │
│    WholesalePriceDiscount = SellingPrice - SupplyPrice      │
│    = 10,000 - 6,000 = 4,000원                              │
│    👉 오리오가 채널에 4,000원 할인해서 공급                  │
│                                                             │
│ 2️⃣ 오리오 마진 계산 (완사입)                                 │
│    SupplyPrice - UnitCost - LogisticsCost                   │
│    = 6,000 - 5,000 - 500 = 500원                           │
│                                                             │
│ 3️⃣ 마진율 계산                                               │
│    (500 / 6,000) × 100 = 8.33%                             │
│                                                             │
│ 📊 채널(롯데마트) 마진 (참고)                                │
│    PromotionPrice - SupplyPrice                             │
│    = 10,000 - 6,000 = 4,000원                              │
│    마진율: 40%                                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 출력                                                         │
├─────────────────────────────────────────────────────────────┤
│  - WholesalePriceDiscount: 4,000원                          │
│  - CalculatedMarginAmount: 500원                            │
│  - CalculatedMarginRate: 8.33%                              │
│  - 오리오가 원매가 할인으로 4,000원 포기                     │
│  - 채널 마진 증가 → 판매 촉진 효과                          │
└─────────────────────────────────────────────────────────────┘
```

---

### 2-2. 에누리 (BUNDLE_DISCOUNT)

```
┌─────────────────────────────────────────────────────────────┐
│ 입력 데이터                                                  │
├─────────────────────────────────────────────────────────────┤
│ [Promotion]                                                 │
│  - PromotionName: "이마트 3개 구매 할인"                     │
│  - PromotionType: BUNDLE_DISCOUNT                           │
│  - BundleCondition: "3개 구매시 20% 할인"                   │
│  - ChannelType: OFFLINE                                     │
│  - DiscountOwner: ORIO                                      │
│                                                             │
│ [PromotionProduct]                                          │
│  - RegularPrice: 12,000원                                   │
│  - SellingPrice: 10,000원                                   │
│  - PromotionPrice: 8,000원 ⬅️ 20% 할인 적용                 │
│  - SupplyPrice: 7,000원                                     │
│  - UnitCost: 5,000원                                        │
│  - DiscountRate: 20%                                        │
│  - SettlementType: DIRECT                                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 처리 로직                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 1️⃣ 묶음 할인액 계산 (3개 기준)                               │
│    정상가: 10,000 × 3 = 30,000원                           │
│    행사가: 8,000 × 3 = 24,000원                            │
│    할인액: 6,000원                                          │
│                                                             │
│ 2️⃣ 개당 공급가 차이                                          │
│    정상 공급가: 10,000 - 3,000(채널마진) = 7,000원          │
│    행사 공급가: 8,000 - 1,000(채널마진) = 7,000원           │
│    👉 에누리는 소비자가만 할인, 공급가 동일                  │
│                                                             │
│ 3️⃣ 오리오 마진 (개당)                                        │
│    SupplyPrice - UnitCost - LogisticsCost                   │
│    = 7,000 - 5,000 - 500 = 1,500원                         │
│                                                             │
│ 4️⃣ 채널 마진 비교                                            │
│    정상시: 10,000 - 7,000 = 3,000원 (30%)                  │
│    행사시: 8,000 - 7,000 = 1,000원 (12.5%)                 │
│    �� 채널이 마진 양보하여 판매 촉진                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 출력                                                         │
├─────────────────────────────────────────────────────────────┤
│  - BundleCondition: "3개 구매시 20% 할인"                   │
│  - 3개 묶음 할인액: 6,000원                                  │
│  - 오리오 마진: 1,500원/개 (21.4%)                          │
│  - 채널 마진: 1,000원/개 (12.5%)                            │
│  - 총 판매 촉진: 채널이 마진 축소로 기여                     │
└─────────────────────────────────────────────────────────────┘
```

---

### 2-3. 기획/특판 상품 (SPECIAL_PRODUCT)

```
┌─────────────────────────────────────────────────────────────┐
│ 입력 데이터                                                  │
├─────────────────────────────────────────────────────────────┤
│ [Promotion]                                                 │
│  - PromotionName: "대형마트 설 기획전"                       │
│  - PromotionType: SPECIAL_PRODUCT                           │
│  - ChannelType: OFFLINE                                     │
│  - ChannelNames: "이마트, 홈플러스, 롯데마트"                │
│                                                             │
│ [PromotionProduct]                                          │
│  - RegularPrice: NULL (기획상품은 정가 없음)                │
│  - SellingPrice: 15,000원 (기획 세트 가격)                  │
│  - PromotionPrice: 15,000원                                 │
│  - SupplyPrice: 10,000원 (기획 공급가)                      │
│  - UnitCost: 7,000원 (세트 원가)                            │
│  - SettlementType: DIRECT                                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 처리 로직                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 1️⃣ 기획상품 특성                                             │
│    - 정가 개념 없음 (기획 전용 제품)                         │
│    - 사전 협의된 공급가/판매가                               │
│    - 시즌/이벤트 전용                                        │
│                                                             │
│ 2️⃣ 오리오 마진                                               │
│    SupplyPrice - UnitCost - LogisticsCost                   │
│    = 10,000 - 7,000 - 500 = 2,500원                        │
│    마진율: 25%                                               │
│                                                             │
│ 3️⃣ 채널 마진                                                 │
│    SellingPrice - SupplyPrice                               │
│    = 15,000 - 10,000 = 5,000원                             │
│    마진율: 33.3%                                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 데이터 흐름 요약

```
┌──────────────────────────────────────────────────────────────────┐
│                      데이터 입력                                  │
│                 (Promotion + PromotionProduct)                   │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
    ┌──────────────────┐            ┌──────────────────┐
    │  ONLINE          │            │  OFFLINE         │
    │  ChannelType     │            │  ChannelType     │
    └──────────────────┘            └──────────────────┘
              │                               │
              ▼                               ▼
    ┌──────────────────┐            ┌──────────────────┐
    │ vw_Promotion     │            │ vw_Promotion     │
    │ Online           │            │ Offline          │
    └──────────────────┘            └──────────────────┘
              │                               │
              │                               │
    ┌─────────┴─────────┐          ┌─────────┴─────────┐
    │                   │          │                   │
    ▼                   ▼          ▼                   ▼
┌─────────┐      ┌─────────┐  ┌─────────┐      ┌─────────┐
│판매가   │      │쿠폰     │  │원매가   │      │에누리   │
│할인     │      │할인     │  │할인     │      │묶음할인 │
└─────────┘      └─────────┘  └─────────┘      └─────────┘
                                                     │
                                              ┌──────┴──────┐
                                              ▼             ▼
                                         ┌─────────┐  ┌─────────┐
                                         │기획상품 │  │특판상품 │
                                         └─────────┘  └─────────┘
              │                               │
              └───────────────┬───────────────┘
                              ▼
              ┌────────────────────────────────┐
              │    vw_PromotionAll (통합)      │
              │    vw_PromotionSummary (요약)  │
              └────────────────────────────────┘
                              │
                              ▼
              ┌────────────────────────────────┐
              │        대시보드 / 리포트        │
              │  - 행사별 성과                 │
              │  - 채널별 마진                 │
              │  - 할인 분담 분석              │
              └────────────────────────────────┘
```

---

## 4. 핵심 차이점 요약

| 구분 | 온라인 | 오프라인 |
|------|--------|----------|
| **정산 방식** | 위탁 중심 (CONSIGNMENT) | 완사입 중심 (DIRECT) |
| **수수료** | 있음 (15~20%) | 없음 |
| **마진 계산 기준** | 판매가 기준 | 공급가 기준 |
| **할인 방식** | 판매가 할인 + 쿠폰 | 원매가/에누리/기획 |
| **할인 분담** | 오리오/채널 분담 | 주로 오리오 또는 채널 단독 |
| **물류비** | 개별 배송비 | 대량 물류비 |
| **재고 위치** | 오리오 또는 풀필먼트 센터 | 채널 매장 |

---

## 5. View 활용 예시

### 온라인 위탁 행사 마진 분석
```sql
SELECT
    PromotionName,
    ProductName,
    PromotionPrice,
    CommissionRate,
    CalculatedMarginAmount,
    CalculatedMarginRate
FROM vw_PromotionOnline
WHERE SettlementType = N'CONSIGNMENT'
ORDER BY CalculatedMarginRate DESC;
```

### 오프라인 원매가 할인 효과 분석
```sql
SELECT
    PromotionName,
    ChannelNames,
    WholesalePriceDiscount,
    SupplyPrice,
    CalculatedMarginAmount,
    CalculatedMarginRate
FROM vw_PromotionOffline
WHERE PromotionType = N'WHOLESALE_DISCOUNT';
```

### 채널별 행사 요약
```sql
SELECT
    ChannelType,
    PromotionType,
    COUNT(*) AS 행사수,
    AVG(CalculatedMarginRate) AS 평균마진율,
    SUM(TargetSalesAmount) AS 목표매출합계
FROM vw_PromotionAll
GROUP BY ChannelType, PromotionType;
```
