{% extends "base.html" %}

{% block title %}BOM 관리 - Orio ERP v2{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fa-solid fa-sitemap"></i> BOM 관리
    </h1>
    <p class="page-subtitle">부품 구성표(Bill of Materials) 관리</p>
</div>

<!-- 검색 필터 -->
<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <div class="card-title" style="margin:0;"><i class="fa-solid fa-filter"></i> 검색 필터</div>
        <div style="display:flex;gap:12px;margin:0;">
            <button class="btn btn-secondary btn-sm" onclick="resetFilters()">
                <i class="fa-solid fa-rotate-right"></i> 초기화
            </button>
            <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                <i class="fa-solid fa-search"></i> 검색
            </button>
        </div>
    </div>
    <div class="search-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
        <div>
            <label class="form-label">세트 품목코드</label>
            <input type="text" id="filterParentERP" class="form-input" list="parentERPList" placeholder="세트 품목코드 검색...">
            <datalist id="parentERPList"></datalist>
        </div>
        <div>
            <label class="form-label">세트 제품명</label>
            <input type="text" id="filterParentName" class="form-input" list="parentNameList"
                placeholder="부모 제품명 검색...">
            <datalist id="parentNameList"></datalist>
        </div>
        <div>
            <label class="form-label">구성품 품목코드</label>
            <input type="text" id="filterChildERP" class="form-input" list="childERPList" placeholder="자식 품목코드 검색...">
            <datalist id="childERPList"></datalist>
        </div>
        <div>
            <label class="form-label">구성품 제품명</label>
            <input type="text" id="filterChildName" class="form-input" list="childNameList" placeholder="자식 제품명 검색...">
            <datalist id="childNameList"></datalist>
        </div>
    </div>
</div>

<!-- Master-Detail Layout -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
    <!-- Master: Parent Products (세트 제품) -->
    <div class="card">
        <div style="margin-bottom:16px;">
            <div
                style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">
                <h2 class="card-title" style="margin:0;white-space:nowrap;">세트 목록</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn btn-success btn-sm" onclick="showAddBOMModal()">
                        <i class="fa-solid fa-plus"></i> BOM 추가
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="selectAllData()">
                        <i class="fa-solid fa-check-double"></i> 전체 선택
                    </button>
                    <button class="btn btn-primary btn-sm btn-disabled" onclick="bulkEdit()" id="editButton">
                        <i class="fa-solid fa-edit"></i> 선택 수정
                    </button>
                    <button class="btn btn-danger btn-sm btn-disabled" onclick="bulkDelete()" id="deleteButton">
                        <i class="fa-solid fa-trash"></i> 선택 삭제
                    </button>
                </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="color:var(--text-muted);font-size:13px;" id="totalCount">총 0개</span>
                <span style="color:var(--text-muted);font-size:13px;" id="filteredCount"></span>
            </div>
        </div>

        <div class="table-container">
            <table class="table" id="master-table">
                <thead>
                    <tr></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="pagination" style="display:flex;justify-content:center;gap:8px;margin-top:20px;"></div>
    </div>

    <!-- Detail: Child Products (구성품) -->
    <div class="card">
        <div style="margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <h2 class="card-title" style="margin:0;">구성품 목록</h2>
                <div style="display:flex;gap:8px;display:none;" id="childActionButtons">
                    <button class="btn btn-success btn-sm" onclick="showAddChildModal()">
                        <i class="fa-solid fa-plus"></i> 구성품 추가
                    </button>
                    <button class="btn btn-primary btn-sm btn-disabled" onclick="bulkEditChildren()"
                        id="editChildButton">
                        <i class="fa-solid fa-edit"></i> 선택 수정
                    </button>
                    <button class="btn btn-danger btn-sm btn-disabled" onclick="bulkDeleteChildren()"
                        id="deleteChildButton">
                        <i class="fa-solid fa-trash"></i> 선택 삭제
                    </button>
                </div>
            </div>
            <span style="color:var(--text-muted);font-size:13px;display:none;" id="childCount">구성품 0개</span>
        </div>

        <div id="detailPlaceholder" style="text-align:center;padding:60px 20px;color:var(--text-muted);">
            <i class="fa-solid fa-hand-pointer"
                style="font-size:48px;margin-bottom:16px;opacity:0.3;display:block;"></i>
            <p>세트 제품을 선택하세요</p>
        </div>

        <div class="table-container" id="childTableContainer" style="display:none;">
            <table class="table" id="detail-table">
                <thead>
                    <tr>
                        <th>BOMID</th>
                        <th>품목코드</th>
                        <th>제품명</th>
                        <th>소요수량</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add BOM Modal -->
<div id="addBOMModal" class="modal">
    <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
            <h2 class="modal-title">BOM 추가</h2>
            <button class="modal-close" onclick="closeAddBOMModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required">세트 품목코드 (부모)</label>
                <input type="text" id="bomParentERP" class="form-input" list="parentERPList" placeholder="예: SET-001">
            </div>

            <div style="margin-top:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <label class="form-label required" style="margin:0;">구성품 목록</label>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addChildRow()">
                        <i class="fa-solid fa-plus"></i> 행 추가
                    </button>
                </div>
                <div id="childRowsContainer" style="max-height:300px;overflow-y:auto;padding-right:4px;">
                    <!-- Child Rows will be added here -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddBOMModal()">취소</button>
            <button class="btn btn-primary" onclick="saveBOM()">저장</button>
        </div>
    </div>
</div>

<!-- Add Child Modal -->
<div id="addChildModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">구성품 추가</h2>
            <button class="modal-close" onclick="closeAddChildModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required">자식 품목코드</label>
                <input type="text" id="childERP" class="form-input" list="childERPList">
            </div>
            <div class="form-group">
                <label class="form-label required">소요수량</label>
                <input type="number" id="childQuantity" class="form-input" value="1" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddChildModal()">취소</button>
            <button class="btn btn-primary" onclick="saveChild()">저장</button>
        </div>
    </div>
</div>

<!-- Bulk Edit Parent Modal (Quantity) -->
<div id="bulkEditParentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">세트 구성품 일괄 수정</h2>
            <button class="modal-close" onclick="closeBulkEditParentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background:var(--bg-hover);padding:12px;border-radius:6px;margin-bottom:16px;">
                <p style="margin:0;color:var(--text-muted);font-size:13px;">
                    <i class="fa-solid fa-info-circle"></i> 선택한 <span id="bulkEditParentCount"
                        style="color:var(--accent);font-weight:600;">0</span>개 세트 제품의
                    <br>모든 구성품 소요수량을 변경합니다.
                </p>
            </div>
            <div class="form-group">
                <label class="form-label">소요수량</label>
                <input type="number" id="bulkParentQuantity" class="form-input" step="0.01">
                <small>현재(첫번째): <span id="currentParentQuantity"></span></small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeBulkEditParentModal()">취소</button>
            <button class="btn btn-primary" onclick="saveBulkEditParent()">저장</button>
        </div>
    </div>
</div>

<!-- Bulk Edit Child Modal -->
<div id="bulkEditChildModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">구성품 선택 수정</h2>
            <button class="modal-close" onclick="closeBulkEditChildModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background:var(--bg-hover);padding:12px;border-radius:6px;margin-bottom:16px;">
                <p style="margin:0;color:var(--text-muted);font-size:13px;">
                    <i class="fa-solid fa-info-circle"></i> 선택한 <span id="bulkEditChildCount"
                        style="color:var(--accent);font-weight:600;">0</span>개 구성품을 수정합니다.
                </p>
            </div>
            <div class="form-group">
                <label class="form-label">자식 품목코드</label>
                <input type="text" id="bulkChildERP" class="form-input" list="childERPList">
                <small>현재: <span id="currentChildERP"></span></small>
            </div>
            <div class="form-group">
                <label class="form-label">소요수량</label>
                <input type="number" id="bulkChildQuantity" class="form-input" step="0.01">
                <small>현재: <span id="currentChildQuantity"></span></small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeBulkEditChildModal()">취소</button>
            <button class="btn btn-primary" onclick="saveBulkEditChild()">저장</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/pages/bom.js"></script>
{% endblock %}