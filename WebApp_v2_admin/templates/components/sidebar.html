<!-- Sidebar Component -->
<nav class="sidebar">
    <div class="sidebar-header">
        <a href="/" class="logo">
            <i class="fa-solid fa-rocket"></i> Orio ERP
        </a>
    </div>

    <div class="nav-links">
        <div class="nav-section-title">Main / 메인</div>
        <a href="/" class="nav-item {% if active_page == 'dashboard' %}active{% endif %}">
            <i class="fa-solid fa-chart-line"></i> 대시보드
        </a>

        <div class="nav-section-title">Management / 관리</div>

        <!-- 판매 관리 서브메뉴 -->
        <div class="nav-group">
            <div class="nav-item nav-group-header" onclick="toggleNavGroup(this)">
                <span><i class="fa-solid fa-won-sign" style="margin-right:6px;"></i> 판매 관리</span>
                <i class="fa-solid fa-chevron-down nav-group-arrow"></i>
            </div>
            <div class="nav-group-items {% if active_page in ['sales', 'revenue-plan'] %}expanded{% endif %}">
                <a href="/sales" class="nav-item nav-sub-item {% if active_page == 'sales' %}active{% endif %}">
                    <i class="fa-solid fa-receipt"></i> 판매 실적
                </a>
                <a href="/revenue-plan" class="nav-item nav-sub-item {% if active_page == 'revenue-plan' %}active{% endif %}">
                    <i class="fa-solid fa-chart-line"></i> 매출 계획
                </a>
            </div>
        </div>
        <a href="/products" class="nav-item {% if active_page == 'products' %}active{% endif %}">
            <i class="fa-solid fa-box"></i> 상품 관리
        </a>
        <a href="/channels" class="nav-item {% if active_page == 'channels' %}active{% endif %}">
            <i class="fa-solid fa-store"></i> 채널 관리
        </a>
        <a href="/bom" class="nav-item {% if active_page == 'bom' %}active{% endif %}">
            <i class="fa-solid fa-sitemap"></i> BOM 관리
        </a>

        <!-- Admin Section (Admin 역할에게만 표시) -->
        <div class="nav-section-title admin-only" style="display: none;">Admin / 관리자</div>
        <a href="/admin/users" class="nav-item admin-only {% if active_page == 'admin-users' %}active{% endif %}"
            style="display: none;">
            <i class="fa-solid fa-users-gear"></i> 사용자 관리
        </a>
        <a href="/admin/activity-log"
            class="nav-item admin-only {% if active_page == 'activity-log' %}active{% endif %}" style="display: none;">
            <i class="fa-solid fa-clock-rotate-left"></i> 활동 이력
        </a>
        <a href="/admin/system-config"
            class="nav-item admin-only {% if active_page == 'system-config' %}active{% endif %}" style="display: none;">
            <i class="fa-solid fa-gear"></i> 시스템 설정
        </a>
    </div>

    <!-- User Info at Bottom -->
    <div class="sidebar-footer" style="margin-top: auto; padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div id="userInfo" style="color: rgba(255,255,255,0.7); font-size: 12px; margin-bottom: 10px;">
            <div id="userName" style="font-weight: 600; color: #fff;"></div>
            <div id="userRole" style="font-size: 11px;"></div>
        </div>
        <button id="btnLogout" class="btn-logout"
            style="width: 100%; padding: 8px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; color: #fca5a5; cursor: pointer; font-size: 12px;">
            <i class="fa-solid fa-right-from-bracket"></i> 로그아웃
        </button>
    </div>
</nav>

<style>
    /* 서브메뉴 스타일 */
    .nav-group {
        margin-bottom: 4px;
    }
    .nav-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    .nav-group-arrow {
        font-size: 10px;
        transition: transform 0.2s;
    }
    .nav-group-items {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
    }
    .nav-group-items.expanded {
        max-height: 200px;
    }
    .nav-sub-item {
        padding-left: 36px !important;
        font-size: 13px;
    }
    .nav-sub-item i {
        font-size: 12px;
    }
    .nav-group-header.active + .nav-group-items,
    .nav-group-items.expanded {
        max-height: 200px;
    }
    .nav-group.open .nav-group-arrow {
        transform: rotate(180deg);
    }
</style>

<script>
    // 서브메뉴 토글
    function toggleNavGroup(header) {
        const group = header.closest('.nav-group');
        const items = group.querySelector('.nav-group-items');
        group.classList.toggle('open');
        items.classList.toggle('expanded');
    }

    // 페이지 로드 시 활성화된 서브메뉴 펼치기
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.nav-group-items.expanded').forEach(items => {
            items.closest('.nav-group').classList.add('open');
        });
    });

    // 사용자 정보 표시 및 Admin 메뉴 제어
    (function () {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = localStorage.getItem('access_token');

        if (!token) {
            // 로그인 페이지가 아닌 경우 리다이렉트
            if (!window.location.pathname.includes('/login')) {
                window.location.href = '/login';
            }
            return;
        }

        // 사용자 정보 표시
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        if (userNameEl && user.name) {
            userNameEl.textContent = user.name;
        }
        if (userRoleEl && user.role) {
            userRoleEl.textContent = user.role;
        }

        // Admin 메뉴 표시 (Admin 역할만)
        if (user.role === 'Admin') {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = '';
            });
        }

        // 로그아웃 버튼
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
            btnLogout.addEventListener('click', async () => {
                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                } catch (e) {
                    // 무시
                }
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
            });
        }
    })();
</script>