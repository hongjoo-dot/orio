<!-- Sidebar Component -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <a href="/" class="logo">
            <i class="fa-solid fa-rocket"></i>
            <span class="logo-text">Orio ERP</span>
        </a>
        <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="사이드바 접기/펴기">
            <i class="fa-solid fa-angles-left"></i>
        </button>
    </div>

    <div class="nav-links">
        <div class="nav-section-title">Main / 메인</div>
        <a href="/" class="nav-item {% if active_page == 'dashboard' %}active{% endif %}">
            <i class="fa-solid fa-chart-line"></i> <span class="nav-text">대시보드</span>
        </a>

        <div class="nav-section-title">Management / 관리</div>

        <!-- 판매 관리 그룹 -->
        <div class="nav-group {% if active_page in ['sales', 'targets', 'expected', 'promotions'] %}open{% endif %}">
            <div class="nav-item nav-group-header {% if active_page in ['sales', 'targets', 'expected', 'promotions'] %}active{% endif %}" onclick="toggleNavGroup(this)">
                <i class="fa-solid fa-won-sign"></i>
                <span class="nav-text">판매 관리</span>
                <i class="fa-solid fa-chevron-down nav-group-arrow"></i>
            </div>
            <div class="nav-group-items {% if active_page in ['sales', 'targets', 'expected', 'promotions'] %}expanded{% endif %}">
                <a href="/sales" class="nav-item nav-sub-item {% if active_page == 'sales' %}active{% endif %}">
                    <i class="fa-solid fa-receipt"></i> <span class="nav-text">판매 현황</span>
                </a>
                <a href="/targets" class="nav-item nav-sub-item {% if active_page == 'targets' %}active{% endif %}">
                    <i class="fa-solid fa-bullseye"></i> <span class="nav-text">목표 관리</span>
                </a>
                <a href="/promotions" class="nav-item nav-sub-item {% if active_page == 'promotions' %}active{% endif %}">
                    <i class="fa-solid fa-tags"></i> <span class="nav-text">행사 관리</span>
                </a>
            </div>
        </div>

        <!-- 상품 관리 그룹 -->
        <div class="nav-group {% if active_page in ['products', 'bom'] %}open{% endif %}">
            <div class="nav-item nav-group-header {% if active_page in ['products', 'bom'] %}active{% endif %}" onclick="toggleNavGroup(this)">
                <i class="fa-solid fa-box"></i>
                <span class="nav-text">상품 관리</span>
                <i class="fa-solid fa-chevron-down nav-group-arrow"></i>
            </div>
            <div class="nav-group-items {% if active_page in ['products', 'bom'] %}expanded{% endif %}">
                <a href="/products" class="nav-item nav-sub-item {% if active_page == 'products' %}active{% endif %}">
                    <i class="fa-solid fa-box"></i> <span class="nav-text">상품 관리</span>
                </a>
                <a href="/bom" class="nav-item nav-sub-item {% if active_page == 'bom' %}active{% endif %}">
                    <i class="fa-solid fa-sitemap"></i> <span class="nav-text">BOM 관리</span>
                </a>
            </div>
        </div>

        <a href="/channels" class="nav-item {% if active_page == 'channels' %}active{% endif %}">
            <i class="fa-solid fa-store"></i> <span class="nav-text">채널 관리</span>
        </a>
        <a href="/withdrawal-plans" class="nav-item {% if active_page == 'withdrawal-plans' %}active{% endif %}">
            <i class="fa-solid fa-clipboard-list"></i> <span class="nav-text">불출 계획</span>
        </a>

        <div class="nav-section-title">Tools / 도구</div>
        <a href="/utilities" class="nav-item {% if active_page == 'utilities' %}active{% endif %}">
            <i class="fa-solid fa-toolbox"></i> <span class="nav-text">유틸리티</span>
        </a>

        <!-- 시스템 관리 그룹 (Admin 역할에게만 표시) -->
        <div class="nav-group admin-only {% if active_page in ['admin-users', 'permissions', 'activity-log', 'system-config'] %}open{% endif %}" style="display: none;">
            <div class="nav-item nav-group-header {% if active_page in ['admin-users', 'permissions', 'activity-log', 'system-config'] %}active{% endif %}" onclick="toggleNavGroup(this)">
                <i class="fa-solid fa-gear"></i>
                <span class="nav-text">시스템 관리</span>
                <i class="fa-solid fa-chevron-down nav-group-arrow"></i>
            </div>
            <div class="nav-group-items {% if active_page in ['admin-users', 'permissions', 'activity-log', 'system-config'] %}expanded{% endif %}">
                <a href="/admin/users" class="nav-item nav-sub-item {% if active_page == 'admin-users' %}active{% endif %}">
                    <i class="fa-solid fa-users-gear"></i> <span class="nav-text">사용자 관리</span>
                </a>
                <a href="/admin/permissions" class="nav-item nav-sub-item {% if active_page == 'permissions' %}active{% endif %}">
                    <i class="fa-solid fa-shield-halved"></i> <span class="nav-text">권한 관리</span>
                </a>
                <a href="/admin/activity-log" class="nav-item nav-sub-item {% if active_page == 'activity-log' %}active{% endif %}">
                    <i class="fa-solid fa-clock-rotate-left"></i> <span class="nav-text">활동 이력</span>
                </a>
                <a href="/admin/system-config" class="nav-item nav-sub-item {% if active_page == 'system-config' %}active{% endif %}">
                    <i class="fa-solid fa-gear"></i> <span class="nav-text">시스템 설정</span>
                </a>
            </div>
        </div>
    </div>

    <!-- User Info at Bottom -->
    <div class="sidebar-footer">
        <div id="userInfo" class="user-info">
            <div id="userName" class="user-name"></div>
            <div id="userRole" class="user-role"></div>
        </div>
        <button id="btnLogout" class="btn-logout">
            <i class="fa-solid fa-right-from-bracket"></i> <span class="nav-text">로그아웃</span>
        </button>
    </div>
</nav>

<style>
    /* 서브메뉴 스타일 */
    .nav-group {
        margin-bottom: 4px;
    }
    .nav-group-header {
        cursor: pointer;
        gap: 12px;
    }
    .nav-group-header i:first-child {
        width: 20px;
        text-align: center;
        flex-shrink: 0;
    }
    .nav-group-arrow {
        font-size: 10px;
        transition: transform 0.2s;
        margin-left: auto;
    }
    .nav-group-items {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
    }
    .nav-group-items.expanded {
        max-height: 200px;
    }
    .nav-sub-item {
        padding-left: 36px !important;
        font-size: 13px;
    }
    .nav-sub-item i {
        font-size: 12px;
    }
    .nav-group-header.active + .nav-group-items,
    .nav-group-items.expanded {
        max-height: 200px;
    }
    .nav-group.open .nav-group-arrow {
        transform: rotate(180deg);
    }
</style>

<script>
    // 서브메뉴 토글
    function toggleNavGroup(header) {
        const group = header.closest('.nav-group');
        const items = group.querySelector('.nav-group-items');
        group.classList.toggle('open');
        items.classList.toggle('expanded');
    }

    // 사이드바 접기/펴기 토글
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector('.main-content');

        sidebar.classList.toggle('collapsed');
        if (mainContent) {
            mainContent.classList.toggle('expanded');
        }

        // localStorage에 상태 저장
        const isCollapsed = sidebar.classList.contains('collapsed');
        localStorage.setItem('sidebarCollapsed', isCollapsed);
    }

    // 페이지 로드 시 사이드바 상태 복원 및 서브메뉴 펼치기
    document.addEventListener('DOMContentLoaded', function() {
        // 서브메뉴 펼치기
        document.querySelectorAll('.nav-group-items.expanded').forEach(items => {
            items.closest('.nav-group').classList.add('open');
        });

        // 사이드바 상태 복원
        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (isCollapsed) {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.add('collapsed');
            if (mainContent) {
                mainContent.classList.add('expanded');
            }
        }
    });

    // 사용자 정보 표시 및 Admin 메뉴 제어
    (function () {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = localStorage.getItem('access_token');

        if (!token) {
            // 로그인 페이지가 아닌 경우 리다이렉트
            if (!window.location.pathname.includes('/login')) {
                window.location.href = '/login';
            }
            return;
        }

        // 사용자 정보 표시
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        if (userNameEl && user.name) {
            userNameEl.textContent = user.name;
        }
        if (userRoleEl && user.role) {
            userRoleEl.textContent = user.role;
        }

        // Admin 메뉴 표시 (Admin 역할만)
        if (user.role === 'Admin') {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = '';
            });
        }

        // 로그아웃 버튼
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
            btnLogout.addEventListener('click', async () => {
                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                } catch (e) {
                    // 무시
                }
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
            });
        }
    })();
</script>