<!-- Top Navbar Component -->
<nav class="topnav" id="topnav">
    <div class="topnav-left">
        <a href="/" class="logo">
            <i class="fa-solid fa-rocket"></i>
            <span class="logo-text">Orio ERP</span>
        </a>

        <div class="nav-links">
            <a href="/" class="nav-item {% if active_page == 'dashboard' %}active{% endif %}">
                <i class="fa-solid fa-chart-line"></i> <span class="nav-text">대시보드</span>
            </a>

            <!-- 판매 관리 드롭다운 -->
            <div class="nav-dropdown {% if active_page in ['sales', 'targets', 'expected', 'promotions'] %}active{% endif %}">
                <div class="nav-item nav-dropdown-toggle {% if active_page in ['sales', 'targets', 'expected', 'promotions'] %}active{% endif %}">
                    <i class="fa-solid fa-won-sign"></i>
                    <span class="nav-text">판매 관리</span>
                    <i class="fa-solid fa-chevron-down nav-dropdown-arrow"></i>
                </div>
                <div class="nav-dropdown-menu">
                    <a href="/sales" class="nav-dropdown-item {% if active_page == 'sales' %}active{% endif %}">
                        <i class="fa-solid fa-receipt"></i> 판매 현황
                    </a>
                    <a href="/targets" class="nav-dropdown-item {% if active_page == 'targets' %}active{% endif %}">
                        <i class="fa-solid fa-bullseye"></i> 목표 관리
                    </a>
                    <a href="/promotions" class="nav-dropdown-item {% if active_page == 'promotions' %}active{% endif %}">
                        <i class="fa-solid fa-tags"></i> 비정기 관리
                    </a>
                </div>
            </div>

            <!-- 상품 관리 드롭다운 -->
            <div class="nav-dropdown {% if active_page in ['products', 'bom'] %}active{% endif %}">
                <div class="nav-item nav-dropdown-toggle {% if active_page in ['products', 'bom'] %}active{% endif %}">
                    <i class="fa-solid fa-box"></i>
                    <span class="nav-text">상품 관리</span>
                    <i class="fa-solid fa-chevron-down nav-dropdown-arrow"></i>
                </div>
                <div class="nav-dropdown-menu">
                    <a href="/products" class="nav-dropdown-item {% if active_page == 'products' %}active{% endif %}">
                        <i class="fa-solid fa-box"></i> 상품 관리
                    </a>
                    <a href="/bom" class="nav-dropdown-item {% if active_page == 'bom' %}active{% endif %}">
                        <i class="fa-solid fa-sitemap"></i> BOM 관리
                    </a>
                </div>
            </div>

            <a href="/channels" class="nav-item {% if active_page == 'channels' %}active{% endif %}">
                <i class="fa-solid fa-store"></i> <span class="nav-text">채널 관리</span>
            </a>
            <a href="/withdrawal-plans" class="nav-item {% if active_page == 'withdrawal-plans' %}active{% endif %}">
                <i class="fa-solid fa-clipboard-list"></i> <span class="nav-text">불출 계획</span>
            </a>
            <a href="/utilities" class="nav-item {% if active_page == 'utilities' %}active{% endif %}">
                <i class="fa-solid fa-toolbox"></i> <span class="nav-text">유틸리티</span>
            </a>

            <!-- 시스템 관리 드롭다운 (Admin만) -->
            <div class="nav-dropdown admin-only {% if active_page in ['admin-users', 'permissions', 'activity-log', 'system-config'] %}active{% endif %}" style="display: none;">
                <div class="nav-item nav-dropdown-toggle {% if active_page in ['admin-users', 'permissions', 'activity-log', 'system-config'] %}active{% endif %}">
                    <i class="fa-solid fa-gear"></i>
                    <span class="nav-text">시스템</span>
                    <i class="fa-solid fa-chevron-down nav-dropdown-arrow"></i>
                </div>
                <div class="nav-dropdown-menu">
                    <a href="/admin/users" class="nav-dropdown-item {% if active_page == 'admin-users' %}active{% endif %}">
                        <i class="fa-solid fa-users-gear"></i> 사용자 관리
                    </a>
                    <a href="/admin/permissions" class="nav-dropdown-item {% if active_page == 'permissions' %}active{% endif %}">
                        <i class="fa-solid fa-shield-halved"></i> 권한 관리
                    </a>
                    <a href="/admin/activity-log" class="nav-dropdown-item {% if active_page == 'activity-log' %}active{% endif %}">
                        <i class="fa-solid fa-clock-rotate-left"></i> 활동 이력
                    </a>
                    <a href="/admin/system-config" class="nav-dropdown-item {% if active_page == 'system-config' %}active{% endif %}">
                        <i class="fa-solid fa-gear"></i> 시스템 설정
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="topnav-right">
        <div id="userInfo" class="user-info">
            <span id="userName" class="user-name"></span>
            <span id="userRole" class="user-role"></span>
        </div>
        <button id="btnLogout" class="btn-logout" title="로그아웃">
            <i class="fa-solid fa-right-from-bracket"></i>
        </button>
    </div>

    <!-- 모바일 햄버거 -->
    <button class="mobile-toggle" id="mobileToggle" onclick="toggleMobileMenu()">
        <i class="fa-solid fa-bars"></i>
    </button>
</nav>

<script>
    // 드롭다운 토글 (클릭)
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.nav-dropdown-toggle').forEach(toggle => {
            toggle.addEventListener('click', function (e) {
                e.stopPropagation();
                const dropdown = this.closest('.nav-dropdown');
                // 다른 드롭다운 닫기
                document.querySelectorAll('.nav-dropdown.open').forEach(d => {
                    if (d !== dropdown) d.classList.remove('open');
                });
                dropdown.classList.toggle('open');
            });
        });

        // 외부 클릭 시 드롭다운 닫기
        document.addEventListener('click', function () {
            document.querySelectorAll('.nav-dropdown.open').forEach(d => {
                d.classList.remove('open');
            });
        });
    });

    // 모바일 메뉴 토글
    function toggleMobileMenu() {
        const topnav = document.getElementById('topnav');
        topnav.classList.toggle('mobile-open');
    }

    // 사용자 정보 표시 및 Admin 메뉴 제어
    (function () {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = localStorage.getItem('access_token');

        if (!token) {
            if (!window.location.pathname.includes('/login')) {
                window.location.href = '/login';
            }
            return;
        }

        // 사용자 정보 표시
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        if (userNameEl && user.name) {
            userNameEl.textContent = user.name;
        }
        if (userRoleEl && user.role) {
            userRoleEl.textContent = user.role;
        }

        // Admin 메뉴 표시
        if (user.role === 'Admin') {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = '';
            });
        }

        // 로그아웃 버튼
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
            btnLogout.addEventListener('click', async () => {
                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                } catch (e) { }
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
            });
        }
    })();
</script>