{% extends "base.html" %}

{% block title %}시스템 설정 - Orio ERP{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fa-solid fa-gear"></i> 시스템 설정
    </h1>
    <p class="page-subtitle">시스템 설정값 관리 및 변경 이력 조회</p>
</div>

    <!-- 필터 영역 -->
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div class="card-title" style="margin:0;"><i class="fa-solid fa-filter"></i> 검색 필터</div>
            <div style="display:flex;gap:12px;margin:0;">
                <button class="btn btn-secondary btn-sm" id="btnResetFilter">
                    <i class="fa-solid fa-rotate-right"></i> 초기화
                </button>
                <button class="btn btn-primary btn-sm" id="btnApplyFilter">
                    <i class="fa-solid fa-search"></i> 검색
                </button>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;">
            <div>
                <label class="form-label">카테고리</label>
                <select id="filterCategory" class="form-select">
                    <option value="">전체</option>
                </select>
            </div>
            <div style="grid-column: span 2;">
                <label class="form-label">검색</label>
                <input type="text" id="searchKeyword" class="form-input" placeholder="ConfigKey 또는 Description 검색...">
            </div>
        </div>
    </div>

    <!-- 설정 목록 -->
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h2 class="card-title" style="margin:0;">설정 목록</h2>
            <div style="display:flex;gap:12px;align-items:center;">
                <button class="btn btn-success btn-sm" onclick="openAddConfigModal()">
                    <i class="fa-solid fa-plus"></i> 새 설정 추가
                </button>
                <span id="totalCount" style="color:var(--text-muted);font-size:13px;">총 0개</span>
            </div>
        </div>
        <div class="table-container">
            <table class="table" id="configTable">
                <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th style="width: 120px;">카테고리</th>
                        <th style="width: 180px;">키</th>
                        <th style="width: 200px;">값</th>
                        <th style="width: 80px;">타입</th>
                        <th style="width: 70px;">활성</th>
                        <th>설명</th>
                        <th style="width: 140px;">수정일시</th>
                        <th style="width: 90px;">수정자</th>
                        <th style="width: 150px;">작업</th>
                    </tr>
                </thead>
                <tbody id="configTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            데이터 로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

<!-- 새 설정 추가 모달 -->
<div id="addConfigModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fa-solid fa-plus"></i> 새 설정 추가</h2>
            <button class="modal-close" onclick="closeAddConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">카테고리 <span style="color: var(--danger);">*</span></label>
                <select id="addCategory" class="form-select">
                    <option value="">선택</option>
                    <option value="Cafe24">Cafe24</option>
                    <option value="Sabangnet">Sabangnet</option>
                    <option value="General">General</option>
                </select>
                <small style="color: var(--text-muted); font-size: 12px;">또는 새 카테고리:</small>
                <input type="text" id="addNewCategory" class="form-input" placeholder="새 카테고리명 (선택사항)" style="margin-top: 5px;">
            </div>
            <div class="form-group">
                <label class="form-label">설정 키 <span style="color: var(--danger);">*</span></label>
                <input type="text" id="addConfigKey" class="form-input" placeholder="예: API_TIMEOUT" required>
            </div>
            <div class="form-group">
                <label class="form-label">설정 값 <span style="color: var(--danger);">*</span></label>
                <input type="text" id="addConfigValue" class="form-input" placeholder="설정값 입력" required>
            </div>
            <div class="form-group">
                <label class="form-label">데이터 타입 <span style="color: var(--danger);">*</span></label>
                <select id="addDataType" class="form-select" required>
                    <option value="string">string</option>
                    <option value="int">int</option>
                    <option value="bool">bool</option>
                    <option value="json">json</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">설명</label>
                <textarea id="addDescription" class="form-input" rows="3" placeholder="설정에 대한 설명을 입력하세요"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">활성 상태</label>
                <select id="addIsActive" class="form-select">
                    <option value="1" selected>활성</option>
                    <option value="0">비활성</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddConfigModal()">취소</button>
            <button class="btn btn-success" onclick="saveNewConfig()">
                <i class="fa-solid fa-save"></i> 추가
            </button>
        </div>
    </div>
</div>

<!-- 설정 수정 모달 -->
<div id="editConfigModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fa-solid fa-pen-to-square"></i> 설정값 수정</h2>
            <button class="modal-close" onclick="closeEditConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">카테고리</label>
                <input type="text" id="editCategory" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">설정 키</label>
                <input type="text" id="editConfigKey" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">데이터 타입</label>
                <input type="text" id="editDataType" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">현재 값</label>
                <input type="text" id="editOldValue" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">새로운 값 <span style="color: var(--danger);">*</span></label>
                <input type="text" id="editNewValue" class="form-input" placeholder="새로운 값을 입력하세요">
            </div>
            <div class="form-group">
                <label class="form-label">설명</label>
                <textarea id="editDescription" class="form-input" rows="2" readonly></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditConfigModal()">취소</button>
            <button class="btn btn-primary" onclick="saveConfigValue()">
                <i class="fa-solid fa-save"></i> 저장
            </button>
        </div>
    </div>
</div>

<!-- 변경 이력 모달 -->
<div id="historyModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2><i class="fa-solid fa-clock-rotate-left"></i> 변경 이력</h2>
            <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">설정 정보</label>
                <div id="historyConfigInfo" style="padding: 10px; background: var(--bg-secondary); border-radius: 6px; font-size: 13px;">
                </div>
            </div>
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 150px;">변경일시</th>
                            <th>이전 값</th>
                            <th>새 값</th>
                            <th style="width: 100px;">변경자</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeHistoryModal()">닫기</button>
        </div>
    </div>
</div>

<script>
    // ========================================================================
    // 전역 변수
    // ========================================================================
    let allConfigs = [];
    let filteredConfigs = [];
    let currentEditConfigId = null;

    // ========================================================================
    // 초기 로드
    // ========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        loadCategories();
        loadConfigs();

        // 필터 이벤트
        document.getElementById('btnApplyFilter').addEventListener('click', applyFilter);
        document.getElementById('btnResetFilter').addEventListener('click', resetFilter);
        document.getElementById('searchKeyword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyFilter();
        });

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAddConfigModal();
                closeEditConfigModal();
                closeHistoryModal();
            }
        });

        // 모달 외부 클릭시 닫기
        document.getElementById('addConfigModal').addEventListener('click', (e) => {
            if (e.target.id === 'addConfigModal') closeAddConfigModal();
        });
        document.getElementById('editConfigModal').addEventListener('click', (e) => {
            if (e.target.id === 'editConfigModal') closeEditConfigModal();
        });
        document.getElementById('historyModal').addEventListener('click', (e) => {
            if (e.target.id === 'historyModal') closeHistoryModal();
        });
    });

    // ========================================================================
    // 데이터 로드
    // ========================================================================
    async function loadCategories() {
        try {
            const response = await api.get('/api/system-config/categories');
            const categories = response.categories || [];

            const select = document.getElementById('filterCategory');
            select.innerHTML = '<option value="">전체</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('카테고리 로드 실패:', error);
        }
    }

    async function loadConfigs(category = null) {
        try {
            const url = category ? `/api/system-config/configs?category=${category}` : '/api/system-config/configs';
            const response = await api.get(url);

            allConfigs = response.configs || [];
            filteredConfigs = [...allConfigs];

            renderConfigTable();
        } catch (error) {
            console.error('설정 로드 실패:', error);
            showAlert('설정 로드에 실패했습니다.', 'danger');
        }
    }

    // ========================================================================
    // 테이블 렌더링
    // ========================================================================
    function renderConfigTable() {
        const tbody = document.getElementById('configTableBody');
        const totalCount = document.getElementById('totalCount');

        totalCount.textContent = `총 ${filteredConfigs.length}개`;

        if (filteredConfigs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        설정이 없습니다.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = filteredConfigs.map(config => `
            <tr>
                <td>${config.ConfigID}</td>
                <td><span class="badge badge-primary">${config.Category}</span></td>
                <td style="font-weight: 500;">${config.ConfigKey}</td>
                <td style="font-family: 'Courier New', monospace; color: var(--primary);">${config.ConfigValue || '-'}</td>
                <td><span class="badge badge-secondary">${config.DataType}</span></td>
                <td style="text-align: center;">
                    ${config.IsActive
                        ? '<i class="fa-solid fa-circle-check" style="color: var(--success);"></i>'
                        : '<i class="fa-solid fa-circle-xmark" style="color: var(--danger);"></i>'
                    }
                </td>
                <td style="font-size: 12px; color: var(--text-muted);">${config.Description || '-'}</td>
                <td style="font-size: 12px;">${config.UpdatedDate || '-'}</td>
                <td style="font-size: 12px;">${config.UpdatedBy || '-'}</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="openEditConfigModal(${config.ConfigID})" title="수정">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn ${config.IsActive ? 'btn-warning' : 'btn-success'} btn-sm" onclick="toggleConfigStatus(${config.ConfigID})" title="${config.IsActive ? '비활성화' : '활성화'}">
                        <i class="fa-solid ${config.IsActive ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="viewHistory(${config.ConfigID})" title="이력">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteConfig(${config.ConfigID})" title="삭제">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // ========================================================================
    // 필터링
    // ========================================================================
    function applyFilter() {
        const category = document.getElementById('filterCategory').value;
        const keyword = document.getElementById('searchKeyword').value.toLowerCase();

        filteredConfigs = allConfigs.filter(config => {
            const matchCategory = !category || config.Category === category;
            const matchKeyword = !keyword ||
                config.ConfigKey.toLowerCase().includes(keyword) ||
                (config.Description && config.Description.toLowerCase().includes(keyword));

            return matchCategory && matchKeyword;
        });

        renderConfigTable();
    }

    function resetFilter() {
        document.getElementById('filterCategory').value = '';
        document.getElementById('searchKeyword').value = '';
        filteredConfigs = [...allConfigs];
        renderConfigTable();
    }

    // ========================================================================
    // 설정 추가
    // ========================================================================
    function openAddConfigModal() {
        // 폼 초기화
        document.getElementById('addCategory').value = '';
        document.getElementById('addNewCategory').value = '';
        document.getElementById('addConfigKey').value = '';
        document.getElementById('addConfigValue').value = '';
        document.getElementById('addDataType').value = 'string';
        document.getElementById('addDescription').value = '';
        document.getElementById('addIsActive').value = '1';

        document.getElementById('addConfigModal').style.display = 'flex';
    }

    function closeAddConfigModal() {
        document.getElementById('addConfigModal').style.display = 'none';
    }

    async function saveNewConfig() {
        const category = document.getElementById('addNewCategory').value.trim() || document.getElementById('addCategory').value;
        const configKey = document.getElementById('addConfigKey').value.trim();
        const configValue = document.getElementById('addConfigValue').value.trim();
        const dataType = document.getElementById('addDataType').value;
        const description = document.getElementById('addDescription').value.trim();
        const isActive = document.getElementById('addIsActive').value === '1';

        // 유효성 검사
        if (!category) {
            showAlert('카테고리를 선택하거나 입력하세요.', 'warning');
            return;
        }

        if (!configKey) {
            showAlert('설정 키를 입력하세요.', 'warning');
            return;
        }

        if (!configValue) {
            showAlert('설정 값을 입력하세요.', 'warning');
            return;
        }

        // 데이터 타입 검증
        if (dataType === 'int') {
            if (isNaN(configValue)) {
                showAlert('int 타입은 숫자만 입력 가능합니다.', 'warning');
                return;
            }
        } else if (dataType === 'bool') {
            if (!['true', 'false', '1', '0', 'yes', 'no'].includes(configValue.toLowerCase())) {
                showAlert('bool 타입은 true/false, 1/0, yes/no 중 하나를 입력하세요.', 'warning');
                return;
            }
        } else if (dataType === 'json') {
            try {
                JSON.parse(configValue);
            } catch (e) {
                showAlert('json 타입은 유효한 JSON 형식이어야 합니다.', 'warning');
                return;
            }
        }

        try {
            const response = await api.post('/api/system-config/create', {
                category: category,
                config_key: configKey,
                config_value: configValue,
                data_type: dataType,
                description: description || null,
                is_active: isActive
            });

            if (response.config_id) {
                showAlert('새 설정이 추가되었습니다.', 'success');
                closeAddConfigModal();
                loadCategories(); // 카테고리 목록 새로고침
                loadConfigs();
            }
        } catch (error) {
            console.error('설정 추가 실패:', error);
            showAlert(error.message || '설정 추가에 실패했습니다.', 'danger');
        }
    }

    // ========================================================================
    // 설정 수정
    // ========================================================================
    function openEditConfigModal(configId) {
        const config = allConfigs.find(c => c.ConfigID === configId);
        if (!config) return;

        currentEditConfigId = configId;

        document.getElementById('editCategory').value = config.Category;
        document.getElementById('editConfigKey').value = config.ConfigKey;
        document.getElementById('editDataType').value = config.DataType;
        document.getElementById('editOldValue').value = config.ConfigValue || '';
        document.getElementById('editNewValue').value = config.ConfigValue || '';
        document.getElementById('editDescription').value = config.Description || '';

        document.getElementById('editConfigModal').style.display = 'flex';
    }

    function closeEditConfigModal() {
        document.getElementById('editConfigModal').style.display = 'none';
        currentEditConfigId = null;
    }

    async function saveConfigValue() {
        const newValue = document.getElementById('editNewValue').value;

        if (!newValue) {
            showAlert('새로운 값을 입력하세요.', 'warning');
            return;
        }

        try {
            const response = await api.post('/api/system-config/update', {
                config_id: currentEditConfigId,
                new_value: newValue
            });

            if (response.updated) {
                showAlert('설정값이 업데이트되었습니다.', 'success');
                closeEditConfigModal();
                loadConfigs();
            } else {
                showAlert(response.message || '업데이트되지 않았습니다.', 'info');
            }
        } catch (error) {
            console.error('설정 업데이트 실패:', error);
            showAlert('설정 업데이트에 실패했습니다.', 'danger');
        }
    }

    // ========================================================================
    // 활성화 토글
    // ========================================================================
    async function toggleConfigStatus(configId) {
        const config = allConfigs.find(c => c.ConfigID === configId);
        if (!config) return;

        const action = config.IsActive ? '비활성화' : '활성화';
        if (!confirm(`이 설정을 ${action}하시겠습니까?`)) return;

        try {
            const response = await api.post('/api/system-config/toggle', {
                config_id: configId
            });

            if (response.toggled) {
                showAlert(`설정이 ${action}되었습니다.`, 'success');
                loadConfigs();
            }
        } catch (error) {
            console.error('상태 토글 실패:', error);
            showAlert('상태 변경에 실패했습니다.', 'danger');
        }
    }

    // ========================================================================
    // 설정 삭제
    // ========================================================================
    async function deleteConfig(configId) {
        const config = allConfigs.find(c => c.ConfigID === configId);
        if (!config) return;

        if (!confirm(`설정을 삭제하시겠습니까?\n\n카테고리: ${config.Category}\n키: ${config.ConfigKey}\n값: ${config.ConfigValue}\n\n이 작업은 되돌릴 수 없습니다.`)) {
            return;
        }

        try {
            const response = await api.post('/api/system-config/delete', {
                config_id: configId
            });

            if (response.deleted) {
                showAlert('설정이 삭제되었습니다.', 'success');
                loadCategories(); // 카테고리 목록 새로고침
                loadConfigs();
            }
        } catch (error) {
            console.error('설정 삭제 실패:', error);
            showAlert(error.message || '설정 삭제에 실패했습니다.', 'danger');
        }
    }

    // ========================================================================
    // 변경 이력 조회
    // ========================================================================
    async function viewHistory(configId) {
        const config = allConfigs.find(c => c.ConfigID === configId);
        if (!config) return;

        try {
            const response = await api.get(`/api/system-config/history/${configId}`);
            const history = response.history || [];

            // 설정 정보 표시
            document.getElementById('historyConfigInfo').innerHTML = `
                <strong>${config.Category}</strong> / ${config.ConfigKey}<br>
                <span style="color: #6b7280;">현재 값: <span style="color: var(--primary); font-family: 'Courier New', monospace;">${config.ConfigValue || '-'}</span></span>
            `;

            // 이력 테이블 렌더링
            const tbody = document.getElementById('historyTableBody');
            if (history.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: #9ca3af;">
                            변경 이력이 없습니다.
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = history.map(h => `
                    <tr>
                        <td style="font-size: 12px;">${h.ChangedDate}</td>
                        <td style="font-family: 'Courier New', monospace; color: #6b7280;">${h.OldValue || '-'}</td>
                        <td style="font-family: 'Courier New', monospace; color: var(--primary); font-weight: 500;">${h.NewValue || '-'}</td>
                        <td style="font-size: 12px;">${h.ChangedBy}</td>
                    </tr>
                `).join('');
            }

            document.getElementById('historyModal').style.display = 'flex';
        } catch (error) {
            console.error('이력 조회 실패:', error);
            showAlert('이력 조회에 실패했습니다.', 'danger');
        }
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    // ========================================================================
    // 유틸리티
    // ========================================================================
    function showAlert(message, type = 'info') {
        const alertBox = document.createElement('div');
        alertBox.className = `alert alert-${type}`;
        alertBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--${type === 'success' ? 'success' : type === 'danger' ? 'danger' : type === 'warning' ? 'warning' : 'primary'});
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `;
        alertBox.textContent = message;
        document.body.appendChild(alertBox);

        setTimeout(() => {
            alertBox.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => alertBox.remove(), 300);
        }, 3000);
    }
</script>

<style>
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }

    .badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-primary {
        background: var(--primary);
        color: white;
    }

    .badge-secondary {
        background: var(--secondary);
        color: white;
    }
</style>
{% endblock %}
